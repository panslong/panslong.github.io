import{_ as n}from"./plugin-vue_export-helper-c27b6911.js";import{o as s,c as a,d as i}from"./app-de394487.js";const e="/assets/20231106104013-f97f1a81.png",t="/assets/20231106105719-b196242f.png",p="/assets/20231106110004-1ad16f34.png",c="/assets/20231106111205-6aa5867a.png",l="/assets/20231106111226-19f57efc.png",o="/assets/20231106111554-8327753e.png",u="/assets/20231106112038-54c727d8.png",r="/assets/20231106112115-78638916.png",d="/assets/20231106112214-e5bc73fa.png",g="/assets/20231106112452-8411e65d.png",v="/assets/20231106112624-817c0135.png",m="/assets/20231106112730-595d0e48.png",b="/assets/20231106112937-fe006823.png",k="/assets/20231106113207-22571457.png",f="/assets/20231106113347-331e6222.png",h="/assets/20231106113435-fc27787f.png",y="/assets/20231106113758-7877943f.png",x="/assets/20231106114042-2f62d3aa.png",_="/assets/20231106114147-95436bb6.png",w="/assets/20231106114614-2d5b8498.png",z="/assets/20231106115303-164b723d.png",S="/assets/20231106115024-8b8fbacc.png",E="/assets/20231106115418-c7ff4737.png",q="/assets/20231106115459-280c8424.png",I="/assets/20231106141304-aac0b2b6.png",A="/assets/20231106142532-234df90d.png",j="/assets/20231106142811-5e714d9c.png",T="/assets/20231106142911-db2a148c.png",C="/assets/20231106143246-0e0884de.png",L="/assets/20231106143945-abcf0172.png",D="/assets/20231106144055-ef164525.png",P="/assets/20231106144701-92d88c6a.png",O="/assets/20231106144928-037a6dd4.png",M="/assets/20231106145013-61da33c3.png",U="/assets/20231106145109-d50738f7.png",B="/assets/20231106145609-d67baeb7.png",R="/assets/20231106150431-6118a17f.png",H="/assets/20231106151813-45cbad36.png",X="/assets/20231106152436-d865858d.png",N="/assets/20231106152549-2a426e55.png",W="/assets/20231106152620-a885ba72.png",G="/assets/20231106152749-9d1d5ee8.png",V="/assets/20231106152958-c2bb80c9.png",J="/assets/20231106153754-271b4e5d.png",F="/assets/20231106154436-2a35699f.png",$="/assets/20231106154528-13786416.png",Q="/assets/20231106155151-786a2fb1.png",K="/assets/20231106155257-82a867e4.png",Y="/assets/20231106155334-721ce94a.png",Z="/assets/20231106155629-446c6b44.png",nn="/assets/20231106155728-48e2450d.png",sn="/assets/20231106155930-28d9e133.png",an="/assets/20231106160037-10622660.png",en="/assets/20231106160942-81800c28.png",tn="/assets/20231106161045-be478ac4.png",pn="/assets/20231106161331-9d54b07a.png",cn="/assets/20231106161541-c6e8ae2c.png",ln="/assets/20231106161746-f6f4f354.png",on="/assets/20231106162434-dae0bdd7.png",un="/assets/20231106162559-41c9ab65.png",rn="/assets/20231106163016-7710294a.png",dn="/assets/20231106163242-bf2fe6f2.png",gn="/assets/20231106163418-1d4c057e.png",vn="/assets/20231106163534-596289b4.png",mn="/assets/20231106163644-190b36c1.png",bn="/assets/20231106163807-cef3fe26.png",kn="/assets/20231107091550-ef876647.png",fn="/assets/20231107091827-76aa924f.png",hn="/assets/20231107092003-cfa73d19.png",yn="/assets/20231107092955-3a538615.png",xn="/assets/image-20231107092749194-52ac6ba4.png",_n="/assets/20231107092811-17f82e29.png",wn="/assets/20231107092906-2b663e36.png",zn="/assets/20231107093634-e592fd3d.png",Sn="/assets/20231107093912-66551e0b.png",En="/assets/20231107094614-bdfed885.png",qn="/assets/20231107094731-d8822f1e.png",In="/assets/20231107095013-5c12e330.png",An="/assets/20231107095133-c09a4fca.png",jn="/assets/20231107095219-487d3615.png",Tn="/assets/20231107095428-fb3ba8a3.png",Cn="/assets/20231107095613-d3709f67.png",Ln="/assets/20231107095637-f05d910a.png",Dn="/assets/20231107095717-44629843.png",Pn="/assets/20231107100345-cfa63121.png",On="/assets/20231107101453-3de5cc44.png",Mn="/assets/20231107102026-e7717c72.png",Un="/assets/20231107102214-d90b0fd3.png",Bn="/assets/20231107102403-b29b528f.png",Rn="/assets/20231107102613-fedeee7e.png",Hn="/assets/20231107103008-e58f1571.png",Xn="/assets/20231107103205-5a1b8724.png",Nn="/assets/20231107103430-9b9aea69.png",Wn="/assets/20231107103528-ea18d68f.png",Gn="/assets/20231107103738-9dded465.png",Vn="/assets/20231107103821-f3661d97.png",Jn="/assets/20231107105055-54f17813.png",Fn="/assets/20231107105712-538bccc2.png",$n="/assets/20231107110303-15522398.png",Qn="/assets/20231107110847-2609804d.png",Kn="/assets/20231107110947-dd214a95.png",Yn="/assets/20231107111050-9337bc27.png",Zn="/assets/20231107111323-e52aff95.png",ns="/assets/20231107111942-baa8ea0d.png",ss="/assets/20231107141535-f6f984b7.png",as="/assets/20231107142221-6ad549ac.png",is="/assets/20231107142315-f6d8839b.png",es="/assets/20231107142705-6c149801.png",ts="/assets/20231107142842-bd14ad5f.png",ps="/assets/20231107143353-53c7b703.png",cs="/assets/20231107143452-a22dd13f.png",ls="/assets/20231107143526-f7d16bca.png",os="/assets/20231107143648-c028860e.png",us="/assets/20231107143831-73632cea.png",rs="/assets/20231107143934-886ddb55.png",ds="/assets/20231107144056-c08afe4b.png",gs="/assets/20231107144442-953dda42.png",vs="/assets/20231107144412-dbea5664.png",ms="/assets/20231107145059-964ff357.png",bs="/assets/20231107145202-1879801b.png",ks="/assets/20231107145302-fcfccb6b.png",fs={},hs=i(`<h1 id="一、内存溢出和内存泄漏" tabindex="-1"><a class="header-anchor" href="#一、内存溢出和内存泄漏" aria-hidden="true">#</a> 一、内存溢出和内存泄漏</h1><ul><li>内存泄漏：在Java中如果不再使用一个对象，但是该对象依然在GC ROOT的引用链上，这个对象就不会被垃圾回收器回收，这种情况称之为内存泄漏</li><li>内存泄漏绝大多数情况都是由堆内存泄漏引起的</li><li>少量的内存泄漏可以容忍，但是如果发生持续的内存泄漏，就像滚雪球越滚越大，不管多大的内存迟早会被消耗完，最终导致的结果就是内存溢出。但是产生内存溢出并不是只有内存泄漏这一种原因</li><li>内存泄漏导致溢出的常见场景是大型的Java后端 应用中，在处理用户的请求之后，没有及时将用户的数据删除。随着用户请求数量越来越多，内存泄漏的对象占满了堆内存最终导致内存溢出</li></ul><p>示例代码：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/leak&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LeakController2</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> userCache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * 登录接口 传递名字和id,放入hashmap中
     */</span>
    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/login&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">login</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span><span class="token punctuation">{</span>
        userCache<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">300</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/logout&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">logout</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span><span class="token punctuation">{</span>
        userCache<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>当大量调用login接口，而没有调用logout接口，就会导致oom</p><ul><li>第二种常见的场景是分布式任务调度系统如Elastic-job、Quartz等进行任务调度时，被调度的Java应用在调度任务结束中出现了内存泄漏，最终导致多次调度之后内存溢出</li><li>这种产生的内存溢出会影响应用执行下次的调度任务执行。同样重启可以恢复应用使用，但是在调度执行一段时间后依然会出现内存溢出</li></ul><figure><img src="`+e+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><figure><img src="'+t+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h1 id="二、解决内存泄漏-监控-top命令" tabindex="-1"><a class="header-anchor" href="#二、解决内存泄漏-监控-top命令" aria-hidden="true">#</a> 二、解决内存泄漏-监控-top命令</h1><figure><img src="'+p+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>load average: 平均负载（Load Average）是一段时间内系统的平均负载，这个一段时间一般取1分钟、5分钟、15分钟。</p><p>top命令展示的数据默认是按照CPU占有大小排列的，如果要使用mem内存排序，则在输入top命令后，按键盘按下大写字母 &quot;M&quot;</p><figure><img src="'+c+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><figure><img src="'+l+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>top命令只能查看最基础的进程信息，所以只适合做初步筛查</p><h1 id="三、解决内存泄漏-监控-visualvm" tabindex="-1"><a class="header-anchor" href="#三、解决内存泄漏-监控-visualvm" aria-hidden="true">#</a> 三、解决内存泄漏-监控-visualvm</h1><figure><img src="'+o+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>启动方式：</p><p>1.命令行模式下输入 jvisualvm</p><p>2.JDK安装目录下找到jvsualvm.exe，双击打开</p><p>3.IDEA中安装visualvm相关插件</p><figure><img src="'+u+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><figure><img src="'+r+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><figure><img src="'+d+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>也可以在IDEA中安装visualvm启动插件</p><figure><img src="'+g+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>插件安装完成后，需要手动指定目录</p><figure><img src="'+v+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><figure><img src="'+m+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>此时IDEA界面上就会出现visualvm相关的按钮</p><figure><img src="'+b+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>jvisualvm也可以监控远程服务器</p><p>启动java程序需要增加一些参数</p><figure><img src="'+k+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><figure><img src="'+f+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><figure><img src="'+h+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p><strong>注意：生产环境中不要使用这中方式</strong>，测试环境可以使用这种方式来查看问题</p><h1 id="四、解决内存泄漏-监控-arthas" tabindex="-1"><a class="header-anchor" href="#四、解决内存泄漏-监控-arthas" aria-hidden="true">#</a> 四、解决内存泄漏-监控-Arthas</h1><figure><img src="'+y+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><figure><img src="'+x+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><figure><img src="'+_+`" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>        &lt;dependency&gt;
            &lt;groupId&gt;com.taobao.arthas&lt;/groupId&gt;
            &lt;artifactId&gt;arthas-spring-boot-starter&lt;/artifactId&gt;
            &lt;version&gt;3.7.1&lt;/version&gt;
        &lt;/dependency&gt;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>arthas:
  #tunnel地址，目前是部署在同一台服务器，正式环境需要拆分
  tunnel-server: ws://localhost:7777/ws
  #tunnel显示的应用名称，直接使用应用名
  app-name: \${spring.application.name}
  #arthas http访问的端口和远程连接的端口
  http-port: 8888
  telnet-port: 9999
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="`+w+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>tunnel页面管理默认使用的端口号是8080</p><p>启动两个Java程序，注意端口号</p><figure><img src="'+z+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><figure><img src="'+S+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><figure><img src="'+E+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><figure><img src="'+q+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h1 id="五、解决内存泄漏-监控-prometheus-grafana" tabindex="-1"><a class="header-anchor" href="#五、解决内存泄漏-监控-prometheus-grafana" aria-hidden="true">#</a> 五、解决内存泄漏-监控-Prometheus+ Grafana</h1><figure><img src="'+I+`" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>  &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-starter-actuator&lt;/artifactId&gt;

            &lt;exclusions&gt;&lt;!-- 去掉springboot默认配置 --&gt;
                &lt;exclusion&gt;
                    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
                    &lt;artifactId&gt;spring-boot-starter-logging&lt;/artifactId&gt;
                &lt;/exclusion&gt;
            &lt;/exclusions&gt;
        &lt;/dependency&gt;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>management:
	endpoints:
    	web:
      		exposure:
        	include: &#39;*&#39; #开放所有端口
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>        &lt;dependency&gt;
            &lt;groupId&gt;io.micrometer&lt;/groupId&gt;
            &lt;artifactId&gt;micrometer-registry-prometheus&lt;/artifactId&gt;
            &lt;scope&gt;runtime&lt;/scope&gt;
        &lt;/dependency&gt;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>management:
  endpoint:
    metrics:
      enabled: true #支持metrics
    prometheus:
      enabled: true #支持Prometheus
  metrics:
    export:
      prometheus:
        enabled: true
    tags:
      application: jvm-test #实例名采集
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="`+A+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><figure><img src="'+j+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><figure><img src="'+T+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h1 id="六、解决内存泄漏-堆内存状况对比" tabindex="-1"><a class="header-anchor" href="#六、解决内存泄漏-堆内存状况对比" aria-hidden="true">#</a> 六、解决内存泄漏-堆内存状况对比</h1><figure><img src="'+C+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h1 id="七、内存泄漏产生的几大原因-代码问题" tabindex="-1"><a class="header-anchor" href="#七、内存泄漏产生的几大原因-代码问题" aria-hidden="true">#</a> 七、内存泄漏产生的几大原因（代码问题）</h1><figure><img src="'+L+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h2 id="_1、equals和hashcode导致的内存泄漏" tabindex="-1"><a class="header-anchor" href="#_1、equals和hashcode导致的内存泄漏" aria-hidden="true">#</a> 1、equals和hashCode导致的内存泄漏</h2><figure><img src="'+D+`" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>public class Demo2 {
    public static long count = 0;
    public static Map&lt;Student,Long&gt; map = new HashMap&lt;&gt;();
    public static void main(String[] args) throws InterruptedException {
        while (true){
            if(count++ % 100 == 0){
                Thread.sleep(10);
            }
            Student student = new Student();
            student.setId(1);
            student.setName(&quot;张三&quot;);
            map.put(student,1L);
        }
    }
}

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>public class Student {
    private String name;
    private Integer id;
    private byte[] bytes = new byte[1024 * 1024];

    public String getName() {
        return name;
    }

    public void setName(String name) {
        this.name = name;
    }

    public Integer getId() {
        return id;
    }

    public void setId(Integer id) {
        this.id = id;
    }
 }
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="`+P+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><figure><img src="'+O+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><figure><img src="'+M+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><figure><img src="'+U+`" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>public class Student {
    private String name;
    private Integer id;
    private byte[] bytes = new byte[1024 * 1024];

    public String getName() {
        return name;
    }

    public void setName(String name) {
        this.name = name;
    }

    public Integer getId() {
        return id;
    }

    public void setId(Integer id) {
        this.id = id;
    }

    @Override
    public boolean equals(Object o) {
        if (this == o) {
            return true;
        }

        if (o == null || getClass() != o.getClass()) {
            return false;
        }

        Student student = (Student) o;

        return new EqualsBuilder().append(id, student.id).isEquals();
    }

    @Override
    public int hashCode() {
        return new HashCodeBuilder(17, 37).append(id).toHashCode();
    }
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_2、内部类引用外部类" tabindex="-1"><a class="header-anchor" href="#_2、内部类引用外部类" aria-hidden="true">#</a> 2、内部类引用外部类</h2><figure><img src="`+B+`" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>public class Outer{
    private byte[] bytes = new byte[1024]; //外部类持有数据
    private String name  = &quot;测试&quot;;
    class Inner{
        private String name;
        public Inner() {
            this.name = Outer.this.name;
        }
    }

    public static void main(String[] args) throws IOException, InterruptedException {
//        System.in.read();
        int count = 0;
        ArrayList&lt;Inner&gt; inners = new ArrayList&lt;&gt;();
        while (true){
            if(count++ % 100 == 0){
                Thread.sleep(10);
            }
            inners.add(new Outer().new Inner());
        }
    }
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="`+R+`" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>可以看到外部类一直无法被回收</p><p>解决方案，内部类改为static</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>public class Outer{
    private byte[] bytes = new byte[1024 * 1024]; //外部类持有数据
    private static String name  = &quot;测试&quot;;
    static class Inner{
        private String name;
        public Inner() {
            this.name = Outer.name;
        }
    }

    public static void main(String[] args) throws IOException, InterruptedException {
//        System.in.read();
        int count = 0;
        ArrayList&lt;Inner&gt; inners = new ArrayList&lt;&gt;();
        while (true){
            if(count++ % 100 == 0){
                Thread.sleep(10);
            }
            inners.add(new Inner());
        }
    }
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_3、threadlocal的使用" tabindex="-1"><a class="header-anchor" href="#_3、threadlocal的使用" aria-hidden="true">#</a> 3、ThreadLocal的使用</h2><figure><img src="`+H+`" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>示例，使用如下代码是没有问题的</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>public class Demo5_1 {
    public static ThreadLocal&lt;Object&gt; threadLocal = new ThreadLocal&lt;&gt;();

    public static void main(String[] args) throws InterruptedException {
        while (true) {
            new Thread(() -&gt; {
                threadLocal.set(new byte[1024 * 1024 * 10]);
            }).start();
            Thread.sleep(10);
        }


    }
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>使用线程池的案例</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>public class Demo5 {
    public static ThreadLocal&lt;Object&gt; threadLocal = new ThreadLocal&lt;&gt;();

    public static void main(String[] args) throws InterruptedException {
        ThreadPoolExecutor threadPoolExecutor = new ThreadPoolExecutor(Integer.MAX_VALUE, Integer.MAX_VALUE,
                0, TimeUnit.DAYS, new SynchronousQueue&lt;&gt;());
        int count = 0;
        while (true) {
            System.out.println(++count);
            threadPoolExecutor.execute(() -&gt; {
                threadLocal.set(new byte[1024 * 1024]);
//                threadLocal.remove();
            });
            Thread.sleep(10);
        }


    }
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>运行一段时间后，会出现内存溢出，解决方案 threadLocal.remove();</p><h2 id="_4、string的intern方法" tabindex="-1"><a class="header-anchor" href="#_4、string的intern方法" aria-hidden="true">#</a> 4、String的intern方法</h2><figure><img src="`+X+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><figure><img src="'+N+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><figure><img src="'+W+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><figure><img src="'+G+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h2 id="_5、通过静态字段保存对象" tabindex="-1"><a class="header-anchor" href="#_5、通过静态字段保存对象" aria-hidden="true">#</a> 5、通过静态字段保存对象</h2><figure><img src="'+V+`" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>@Lazy //懒加载
@Component
public class TestLazy {
    private byte[] bytes = new byte[1024 * 1024 * 1024];
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>如果设置jvm内存大小为500M，没有使用懒加载的话，则程序无法启动。使用@Lazy后，程序可以正常启动，因为当前对象并没有被使用到，就不会被创建</p><h2 id="_6、资源没有正常关闭" tabindex="-1"><a class="header-anchor" href="#_6、资源没有正常关闭" aria-hidden="true">#</a> 6、资源没有正常关闭</h2><figure><img src="`+J+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h1 id="八、产生内存溢出原因-并发请求问题" tabindex="-1"><a class="header-anchor" href="#八、产生内存溢出原因-并发请求问题" aria-hidden="true">#</a> 八、产生内存溢出原因-并发请求问题</h1><figure><img src="'+F+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><figure><img src="'+$+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><figure><img src="'+Q+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><figure><img src="'+K+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><figure><img src="'+Y+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><figure><img src="'+Z+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><figure><img src="'+nn+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><figure><img src="'+sn+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><figure><img src="'+an+`" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>    <span class="token doc-comment comment">/**
     * 大量数据 + 处理慢
     */</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/test&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">test1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bytes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">100</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//100m</span>
        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">10</span> <span class="token operator">*</span> <span class="token number">1000L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="`+en+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><figure><img src="'+tn+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>![](./images.assets/20231106161045.png</p><figure><img src="'+pn+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>此时会自动把函数复制到粘贴板中</p><figure><img src="'+cn+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><figure><img src="'+ln+`" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>    /**
     * 登录接口 传递名字和id,放入hashmap中
     */
    @PostMapping(&quot;/login&quot;)
    public void login(String name,Long id){
        userCache.put(id,new UserEntity(id,name));
    }
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h1 id="九、诊断-mat工具" tabindex="-1"><a class="header-anchor" href="#九、诊断-mat工具" aria-hidden="true">#</a> 九、诊断（mat工具）</h1><figure><img src="`+on+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><figure><img src="'+un+`" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>-XX:+HeapDumpOnOutOfMemoryError 

-XX:HeapDumpPath=D:\\jvm\\dump\\jvm2.hprof
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="`+rn+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>打开mat工具，选择dump文件</p><figure><img src="'+dn+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><figure><img src="'+gn+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><figure><img src="'+vn+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><figure><img src="'+mn+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><figure><img src="'+bn+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><figure><img src="'+kn+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><figure><img src="'+fn+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><figure><img src="'+hn+`" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>//-XX:+HeapDumpBeforeFullGC -XX:HeapDumpPath=D:/jvm/dump/mattest.hprof
public class HeapDemo {
    public static void main(String[] args) {
        TestClass a1 = new TestClass();
        TestClass a2 = new TestClass();
        TestClass a3 = new TestClass();
        String s1 = &quot;itheima1&quot;;
        String s2 = &quot;itheima2&quot;;
        String s3 = &quot;itheima3&quot;;

        a1.list.add(s1);

        a2.list.add(s1);
        a2.list.add(s2);

        a3.list.add(s3);

        //System.out.print(ClassLayout.parseClass(TestClass.class).toPrintable());
        s1 = null;
        s2 = null;
        s3 = null;
        System.gc();
    }
}

class TestClass {
    public List&lt;String&gt; list = new ArrayList&lt;&gt;(10);
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>分析代码中的支配树</p><figure><img src="`+yn+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>执行代码，生成mattest.hprof文件，打开mat工具分析</p><figure><img src="'+xn+'" alt="image-20231107092749194" tabindex="0" loading="lazy"><figcaption>image-20231107092749194</figcaption></figure><p>搜索main线程，发现工具上展示的和我们分析的支配树一样</p><figure><img src="'+_n+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><figure><img src="'+wn+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><figure><img src="'+zn+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h1 id="十、导出运行中系统-还未溢出-的内存快照进行分析" tabindex="-1"><a class="header-anchor" href="#十、导出运行中系统-还未溢出-的内存快照进行分析" aria-hidden="true">#</a> 十、导出运行中系统（还未溢出）的内存快照进行分析</h1><figure><img src="'+Sn+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p><img src="'+En+'" alt="" loading="lazy"><img src="'+qn+'" alt="" loading="lazy"></p><p>服务器上执行完命令后，会生成下面三个报告文件</p><figure><img src="'+In+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>下载解压第一份内存报告</p><figure><img src="'+An+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>打开Index.html页面，展示的内容和mat上看到的一样</p><figure><img src="'+jn+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h1 id="十一、修复内容" tabindex="-1"><a class="header-anchor" href="#十一、修复内容" aria-hidden="true">#</a> 十一、修复内容</h1><figure><img src="'+Tn+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h2 id="_1、查询大数据量导致的内存溢出" tabindex="-1"><a class="header-anchor" href="#_1、查询大数据量导致的内存溢出" aria-hidden="true">#</a> 1、查询大数据量导致的内存溢出</h2><figure><img src="'+Cn+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><figure><img src="'+Ln+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><figure><img src="'+Dn+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><figure><img src="'+Pn+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><figure><img src="'+On+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h2 id="_2、mybatis导致的内存溢出" tabindex="-1"><a class="header-anchor" href="#_2、mybatis导致的内存溢出" aria-hidden="true">#</a> 2、mybatis导致的内存溢出</h2><figure><img src="'+Mn+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>分析hprof文件，查看直方图，按大小排序，发现前几个占用的大小比后面的高出很多</p><figure><img src="'+Un+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>发现是tomcat线程，找到支配树，找到HandlerMethod方法，查看引用</p><figure><img src="'+Bn+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><figure><img src="'+Rn+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><figure><img src="'+Hn+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><figure><img src="'+Xn+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h2 id="_3、导出大文件内存溢出" tabindex="-1"><a class="header-anchor" href="#_3、导出大文件内存溢出" aria-hidden="true">#</a> 3、导出大文件内存溢出</h2><figure><img src="'+Nn+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><figure><img src="'+Wn+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><figure><img src="'+Gn+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><figure><img src="'+Vn+`" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>​</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/excel&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Demo2ExcelController</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/export&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">export</span><span class="token punctuation">(</span><span class="token keyword">int</span> size<span class="token punctuation">,</span> <span class="token class-name">String</span> path<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token comment">// 1 、创建工作薄</span>
        <span class="token class-name">Workbook</span> workbook <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XSSFWorkbook</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2、在工作薄中创建sheet</span>
        <span class="token class-name">Sheet</span> sheet <span class="token operator">=</span> workbook<span class="token punctuation">.</span><span class="token function">createSheet</span><span class="token punctuation">(</span><span class="token string">&quot;测试&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> size<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 3、在sheet中创建行</span>
            <span class="token class-name">Row</span> row0 <span class="token operator">=</span> sheet<span class="token punctuation">.</span><span class="token function">createRow</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 4、创建单元格并存入数据</span>
            row0<span class="token punctuation">.</span><span class="token function">createCell</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setCellValue</span><span class="token punctuation">(</span><span class="token class-name">RandomStringUtils</span><span class="token punctuation">.</span><span class="token function">randomAlphabetic</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>


        <span class="token comment">// 将文件输出到指定文件</span>
        <span class="token class-name">FileOutputStream</span> fileOutputStream <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            fileOutputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileOutputStream</span><span class="token punctuation">(</span>path <span class="token operator">+</span> <span class="token class-name">RandomStringUtils</span><span class="token punctuation">.</span><span class="token function">randomAlphabetic</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;.xlsx&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            workbook<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>fileOutputStream<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>fileOutputStream <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                fileOutputStream<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>workbook <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                workbook<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>


    <span class="token comment">//http://www.hutool.cn/docs/#/poi/Excel%E5%A4%A7%E6%95%B0%E6%8D%AE%E7%94%9F%E6%88%90-BigExcelWriter</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/export_hutool&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">export_hutool</span><span class="token punctuation">(</span><span class="token keyword">int</span> size<span class="token punctuation">,</span> <span class="token class-name">String</span> path<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>


        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> rows <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> size<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
           rows<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span> <span class="token class-name">CollUtil</span><span class="token punctuation">.</span><span class="token function">newArrayList</span><span class="token punctuation">(</span><span class="token class-name">RandomStringUtils</span><span class="token punctuation">.</span><span class="token function">randomAlphabetic</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">BigExcelWriter</span> writer<span class="token operator">=</span> <span class="token class-name">ExcelUtil</span><span class="token punctuation">.</span><span class="token function">getBigWriter</span><span class="token punctuation">(</span>path <span class="token operator">+</span> <span class="token class-name">RandomStringUtils</span><span class="token punctuation">.</span><span class="token function">randomAlphabetic</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;.xlsx&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 一次性写出内容，使用默认样式</span>
        writer<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>rows<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 关闭writer，释放内存</span>
        writer<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token punctuation">}</span>


    <span class="token comment">//https://easyexcel.opensource.alibaba.com/docs/current/quickstart/write#%E9%87%8D%E5%A4%8D%E5%A4%9A%E6%AC%A1%E5%86%99%E5%85%A5%E5%86%99%E5%88%B0%E5%8D%95%E4%B8%AA%E6%88%96%E8%80%85%E5%A4%9A%E4%B8%AAsheet</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/export_easyexcel&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">export_easyexcel</span><span class="token punctuation">(</span><span class="token keyword">int</span> size<span class="token punctuation">,</span> <span class="token class-name">String</span> path<span class="token punctuation">,</span><span class="token keyword">int</span> batch<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>

        <span class="token comment">// 方法1: 如果写到同一个sheet</span>
        <span class="token class-name">String</span> fileName <span class="token operator">=</span> path <span class="token operator">+</span> <span class="token class-name">RandomStringUtils</span><span class="token punctuation">.</span><span class="token function">randomAlphabetic</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;.xlsx&quot;</span><span class="token punctuation">;</span>
        <span class="token comment">// 这里注意 如果同一个sheet只要创建一次</span>
        <span class="token class-name">WriteSheet</span> writeSheet <span class="token operator">=</span> <span class="token class-name">EasyExcel</span><span class="token punctuation">.</span><span class="token function">writerSheet</span><span class="token punctuation">(</span><span class="token string">&quot;测试&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 这里 需要指定写用哪个class去写</span>
        <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">ExcelWriter</span> excelWriter <span class="token operator">=</span> <span class="token class-name">EasyExcel</span><span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>fileName<span class="token punctuation">,</span> <span class="token class-name">DemoData</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 分100次写入</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> batch<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 分页去数据库查询数据 这里可以去数据库查询每一页的数据</span>
                <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DemoData</span><span class="token punctuation">&gt;</span></span> datas <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> size <span class="token operator">/</span> batch<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">DemoData</span> demoData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DemoData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    demoData<span class="token punctuation">.</span><span class="token function">setString</span><span class="token punctuation">(</span><span class="token class-name">RandomStringUtils</span><span class="token punctuation">.</span><span class="token function">randomAlphabetic</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    datas<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>demoData<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                excelWriter<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>datas<span class="token punctuation">,</span> writeSheet<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//写入之后datas数据就可以释放了</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="`+Jn+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>使用easy excel 分批导出</p><h2 id="_4、threadlocal内存泄漏" tabindex="-1"><a class="header-anchor" href="#_4、threadlocal内存泄漏" aria-hidden="true">#</a> 4、ThreadLocal内存泄漏</h2><figure><img src="'+Fn+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><figure><img src="'+$n+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><figure><img src="'+Qn+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><figure><img src="'+Kn+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><figure><img src="'+Yn+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>接口中error抛出异常，就不会执行到拦截器的postHandle方法</p><p>正确的做法是把 UserDataContextHolder.userData.remove(); 代码放到 afterCompletion中</p><p>正常情况下，tomcat线程使用完，就会进行回收，从而线程中包含的数据也会被回收。</p><p>但是当前案例中，我们对tomcat进行了设置，最大线程数500，核心线程数100，核心线程不会被回收。而我们jmeter设置了30个线程运行，所以这30个线程都不会被回收</p><figure><img src="'+Zn+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><figure><img src="'+ns+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h2 id="_5、文章内容审核接口的内存溢出" tabindex="-1"><a class="header-anchor" href="#_5、文章内容审核接口的内存溢出" aria-hidden="true">#</a> 5、文章内容审核接口的内存溢出</h2><figure><img src="'+ss+`" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">ArticleService</span> articleService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/demo1/{id}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">article1</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span> <span class="token keyword">long</span> id<span class="token punctuation">,</span> <span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">ArticleDto</span> article<span class="token punctuation">)</span><span class="token punctuation">{</span>
        article<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        articleService<span class="token punctuation">.</span><span class="token function">asyncSaveArticle</span><span class="token punctuation">(</span>article<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>    <span class="token annotation punctuation">@Override</span>
    <span class="token annotation punctuation">@Async</span><span class="token punctuation">(</span><span class="token string">&quot;asyncTaskExecutor&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">asyncSaveArticle</span><span class="token punctuation">(</span><span class="token class-name">ArticleDto</span> article<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        aliyunUtil<span class="token punctuation">.</span><span class="token function">verify</span><span class="token punctuation">(</span>article<span class="token punctuation">.</span><span class="token function">getTitle</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;。&quot;</span> <span class="token operator">+</span> article<span class="token punctuation">.</span><span class="token function">getContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AliyunUtil</span> <span class="token punctuation">{</span>

    <span class="token comment">//阿里云审核接口调用</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">verify</span><span class="token punctuation">(</span><span class="token class-name">String</span> content<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token doc-comment comment">/**
             *  调用第三方接口审核数据，但是此时网络出现问题，
             * 第三方接口长时间没有响应，此处使用休眠来模拟30秒
             */</span>
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">30</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@EnableAsync</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AsyncThreadPoolTaskConfig</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> corePoolSize <span class="token operator">=</span> <span class="token number">50</span><span class="token punctuation">;</span>       		<span class="token comment">// 核心线程数（默认线程数）</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> maxPoolSize <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span>			    <span class="token comment">// 最大线程数</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> keepAliveTime <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>			<span class="token comment">// 允许线程空闲时间（单位：默认为秒）</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> queueCapacity <span class="token operator">=</span> <span class="token number">200</span><span class="token punctuation">;</span>			<span class="token comment">// 缓冲队列数</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> threadNamePrefix <span class="token operator">=</span> <span class="token string">&quot;Async-Task-&quot;</span><span class="token punctuation">;</span> <span class="token comment">// 线程池名前缀</span>
 
    <span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span><span class="token string">&quot;asyncTaskExecutor&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">ThreadPoolTaskExecutor</span> <span class="token function">getAsyncExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">ThreadPoolTaskExecutor</span> executor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolTaskExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        executor<span class="token punctuation">.</span><span class="token function">setCorePoolSize</span><span class="token punctuation">(</span>corePoolSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//executor.setMaxPoolSize(Integer.MAX_VALUE);</span>
        executor<span class="token punctuation">.</span><span class="token function">setMaxPoolSize</span><span class="token punctuation">(</span>maxPoolSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
        executor<span class="token punctuation">.</span><span class="token function">setQueueCapacity</span><span class="token punctuation">(</span>queueCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span>
        executor<span class="token punctuation">.</span><span class="token function">setKeepAliveSeconds</span><span class="token punctuation">(</span>keepAliveTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
        executor<span class="token punctuation">.</span><span class="token function">setThreadNamePrefix</span><span class="token punctuation">(</span>threadNamePrefix<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 线程池对拒绝任务的处理策略</span>
        executor<span class="token punctuation">.</span><span class="token function">setRejectedExecutionHandler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor<span class="token punctuation">.</span>AbortPolicy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 初始化</span>
        executor<span class="token punctuation">.</span><span class="token function">initialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> executor<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="`+as+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><figure><img src="'+is+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><figure><img src="'+es+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h1 id="十二、btrace和arthas在线定位问题" tabindex="-1"><a class="header-anchor" href="#十二、btrace和arthas在线定位问题" aria-hidden="true">#</a> 十二、btrace和arthas在线定位问题</h1><figure><img src="'+ts+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><figure><img src="'+ps+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><figure><img src="'+cs+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><figure><img src="'+ls+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><figure><img src="'+os+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><figure><img src="'+us+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>然后jmeter调用接口，云服务器控制台就会出现UserEntity的方法</p><figure><img src="'+rs+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>stack命令比较简单，如果要追踪比较复杂的问题，比如追踪的时候要打印参数等内容，就可以用btrace</p><figure><img src="'+ds+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><figure><img src="'+gs+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><figure><img src="'+vs+`" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>    &lt;dependencies&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.openjdk.btrace&lt;/groupId&gt;
            &lt;artifactId&gt;btrace-agent&lt;/artifactId&gt;
            &lt;version&gt;\${btrace.version}&lt;/version&gt;
            &lt;scope&gt;system&lt;/scope&gt;
            &lt;systemPath&gt;D:\\tools\\btrace-v2.2.4-bin\\libs\\btrace-agent.jar&lt;/systemPath&gt;
        &lt;/dependency&gt;

        &lt;dependency&gt;
            &lt;groupId&gt;org.openjdk.btrace&lt;/groupId&gt;
            &lt;artifactId&gt;btrace-boot&lt;/artifactId&gt;
            &lt;version&gt;\${btrace.version}&lt;/version&gt;
            &lt;scope&gt;system&lt;/scope&gt;
            &lt;systemPath&gt;D:\\tools\\btrace-v2.2.4-bin\\libs\\btrace-boot.jar&lt;/systemPath&gt;
        &lt;/dependency&gt;

        &lt;dependency&gt;
            &lt;groupId&gt;org.openjdk.btrace&lt;/groupId&gt;
            &lt;artifactId&gt;btrace-client&lt;/artifactId&gt;
            &lt;version&gt;\${btrace.version}&lt;/version&gt;
            &lt;scope&gt;system&lt;/scope&gt;
            &lt;systemPath&gt;D:\\tools\\btrace-v2.2.4-bin\\libs\\btrace-client.jar&lt;/systemPath&gt;
        &lt;/dependency&gt;
    &lt;/dependencies&gt;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@BTrace</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TracingUserEntity</span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@OnMethod</span><span class="token punctuation">(</span>
            clazz<span class="token operator">=</span><span class="token string">&quot;com.itheima.jvmoptimize.entity.UserEntity&quot;</span><span class="token punctuation">,</span>
            method<span class="token operator">=</span><span class="token string">&quot;/.*/&quot;</span><span class="token punctuation">)</span>
        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">traceExecute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token function">jstack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h1 id="十三、总结" tabindex="-1"><a class="header-anchor" href="#十三、总结" aria-hidden="true">#</a> 十三、总结</h1><figure><img src="`+ms+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><figure><img src="'+bs+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><figure><img src="'+ks+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure>',214),ys=[hs];function xs(_s,ws){return s(),a("div",null,ys)}const Es=n(fs,[["render",xs],["__file","2022-11-10-JVM-实战篇1.html.vue"]]);export{Es as default};
